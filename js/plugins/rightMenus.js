const RightMenus={defaultEvent:["copyText","copyLink","copyPaste","copyAll","copyCut","copyImg","printMode","readMode"],defaultGroup:["navigation","inputBox","seletctText","elementCheck","elementImage","articlePage"],corsAnywhere:volantis.GLOBAL_CONFIG.plugins.rightmenus.options.corsAnywhere,urlRegx:/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/,imgRegx:/\.(jpe?g|png|webp|svg|gif|jifi|avif)(-|_|!|\?|\/)?.*$/,initialMenu:()=>{RightMenus.fun.init(),volantis.pjax.send((()=>{RightMenus.fun.hideMenu(),volantis.isReadModel&&RightMenus.fun.readMode()}))},readClipboard:async()=>{try{const e=await navigator.permissions.query({name:"clipboard-read"});return"granted"===e.state||"prompt"===e.state?await navigator.clipboard.readText():(window.clipboardRead=!1,"")}catch(e){return console.error("读取剪切板失败: ",e),""}},writeClipText:e=>navigator.clipboard.writeText(e).then((()=>Promise.resolve())).catch((e=>Promise.reject(e))),writeClipImg:async(e,t,n)=>{try{const o=new Image;o.crossOrigin="Anonymous",o.src=`${e}?(lll￢ω￢)~~`,o.onload=()=>{const e=document.createElement("canvas");e.width=o.width,e.height=o.height;e.getContext("2d").drawImage(o,0,0),e.toBlob((e=>{navigator.clipboard.write([new ClipboardItem({"image/png":e})]).then(t).catch(n)}),"image/png")},o.onerror=n}catch(e){n(e)}},insertAtCaret:(e,t)=>{const{selectionStart:n,selectionEnd:o,scrollTop:i}=e,l=e.value.substring(0,n)+t+e.value.substring(o);e.value=l,e.setSelectionRange(n+t.length,n+t.length),e.scrollTop=i,e.focus()}};RightMenus.fun=(()=>{const e=volantis.GLOBAL_CONFIG.plugins.rightmenus,t={},n=document.getElementById("rightmenu-wrapper"),o=document.getElementById("rightmenu-content"),i=document.querySelectorAll("#rightmenu-content li.menuLoad-Content"),l=document.querySelectorAll("#rightmenu-content li, #rightmenu-content hr, #menuMusic"),r=document.getElementById("read_bkg"),a=document.getElementById("menuMusic"),s=document.querySelector("#menuMusic .backward"),c=document.querySelector("#menuMusic .toggle"),d=document.querySelector("#menuMusic .forward");let u={mouseEvent:null,isInputBox:!1,selectText:"",inputValue:"",isLink:!1,linkUrl:"",isMediaLink:!1,mediaLinkUrl:"",isImage:!1,isArticle:!1,pathName:"",isReadClipboard:!0,isShowMusic:!1,statusCheck:!1};const m={...u};return t.initEvent=()=>{t.elementAppend(),t.contextmenu(),t.menuEvent()},t.elementAppend=()=>{r&&r.remove();const e=document.createElement("div");e.className="common_read_bkg common_read_hide",e.id="read_bkg",document.body.appendChild(e)},t.menuPosition=e=>{try{const{clientX:i,clientY:l}=e,r=document.documentElement.clientWidth||document.body.clientWidth,a=document.documentElement.clientHeight||document.body.clientHeight;n.style.display="block",t.menuControl(e);const s=o.offsetWidth,c=o.offsetHeight;let d=i+s>r?i-s+10:i,u=l+c>a?l-c+10:l;l+c>a&&u<c&&l<c&&(u+=a-c-u-10),n.style.left=`${d}px`,n.style.top=`${u}px`}catch(e){return console.error(e),t.hideMenu(),!0}return!1},t.menuControl=n=>{t.globalDataSet(n),a&&(a.style.display=u.isShowMusic?"block":"none"),i.forEach((t=>{const{nodeName:n,dataset:{group:o,event:i}}=t.firstElementChild;if(t.style.display="none",u.statusCheck||u.isArticle)switch(o){case"inputBox":if(u.isInputBox){const e=["copyCut"!==i||u.selectText,"copyAll"!==i||u.inputValue,"copyPaste"!==i||u.isReadClipboard];t.style.display=e.every((e=>e))?"block":"none"}break;case"seletctText":u.selectText&&(t.style.display="block");break;case"elementCheck":(u.isLink||u.isMediaLink)&&(t.style.display="block");break;case"elementImage":u.isImage&&(t.style.display="block");break;case"articlePage":u.isArticle&&(t.style.display="block");break;default:t.style.display="A"===n?u.isArticle&&!u.statusCheck&&e.options.articleShowLink?"block":"none":"block"}else"A"!==n&&RightMenus.defaultGroup.includes(o)||(t.style.display="block")})),volantis.mouseEvent=n,volantis.rightmenu.method.handle.start();let o={item:null,hide:!0};l.forEach((e=>{if("HR"===e.nodeName){if(e.style.display="block",!o.item)return void(o.item=e);(o.hide||"HR"===o.item.nextElementSibling.nodeName)&&(o.item.style.display="none"),o.item=e,o.hide=!0}else"block"===e.style.display&&o.hide&&(o.hide=!1)})),o.item&&o.hide&&(o.item.style.display="none")},t.globalDataSet=t=>{u={...m},u.mouseEvent=t,u.selectText=window.getSelection().toString();const n=t.target.tagName.toLowerCase();u.isInputBox="input"===n||"textarea"===n,u.isInputBox&&(u.inputValue=t.target.value,u.isReadClipboard=!1!==window.clipboardRead);const{href:o,currentSrc:i}=t.target,{urlRegx:l,imgRegx:r}=RightMenus;u.isLink=!!o&&l.test(o),u.linkUrl=u.isLink?o:void 0,u.isMediaLink=!!i&&l.test(i),u.mediaLinkUrl=u.isMediaLink?i:void 0,u.isImage=u.isMediaLink&&r.test(u.mediaLinkUrl),u.isArticle=!!document.querySelector("#post.article"),u.pathName=u.isArticle?window.location.pathname:void 0;const a=volantis.GLOBAL_CONFIG.plugins.aplayer?.enable,s="undefined"!=typeof RightMenuAplayer&&RightMenuAplayer.APlayer.player;if(a&&s){const t=RightMenuAplayer.APlayer.status;u.isShowMusic=e.options.musicAlwaysShow||"play"===t||"undefined"===t}u.statusCheck=!!u.selectText||u.isInputBox||u.isLink||u.isMediaLink},t.contextmenu=()=>{document.oncontextmenu=e=>e.ctrlKey||document.body.offsetWidth<=500?(t.hideMenu(),!0):t.menuPosition(e),n.oncontextmenu=e=>(e.stopPropagation(),e.preventDefault(),!1);const e=()=>t.hideMenu();window.removeEventListener("blur",e),window.addEventListener("blur",e),document.body.removeEventListener("click",e),document.body.addEventListener("click",e)},t.menuEvent=()=>{i.forEach((e=>{const n=e.firstElementChild.getAttribute("data-event"),o=e.firstElementChild.getAttribute("id"),i=e.firstElementChild.getAttribute("data-group");"A"!==e.firstElementChild.nodeName&&e.addEventListener("click",(()=>{try{if(RightMenus.defaultEvent.includes(n))t[n]();else switch(i){case"seletctText":RightMenusFunction[o](u.selectText);break;case"elementCheck":RightMenusFunction[o](u.isLink?u.linkUrl:u.mediaLinkUrl);break;case"elementImage":RightMenusFunction[o](u.mediaLinkUrl);break;default:RightMenusFunction[o]()}}catch(e){"rightMenus"===volantis.GLOBAL_CONFIG.debug&&console.error({id:o,error:e,globalData:u,groupName:i,eventName:n})}}))})),d&&c&&s&&(s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerBackward()})),c.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerToggle()})),d.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerForward()})))},t.hideMenu=()=>{n.style.display=null,n.style.left=null,n.style.top=null},t.copyText=()=>{VolantisApp.utilWriteClipText(u.selectText)},t.copyLink=()=>{VolantisApp.utilWriteClipText(u.linkUrl||u.mediaLinkUrl)},t.copyAll=()=>{u.mouseEvent.target.select()},t.copyPaste=async()=>{const e=await RightMenus.readClipboard()||"";!1===window.clipboardRead?console.error("系统提示","未授予剪切板读取权限！"):""===e?console.error("系统提示","仅支持复制文本内容！"):RightMenus.insertAtCaret(u.mouseEvent.target,e)},t.copyCut=()=>{const{selectionStart:e,selectionEnd:n,value:o}=u.mouseEvent.target;t.copyText(u.selectText),u.mouseEvent.target.value=o.substring(0,e)+o.substring(n),u.mouseEvent.target.setSelectionRange(e,e),u.mouseEvent.target.focus()},t.copyImg=()=>{RightMenus.writeClipImg(u.mediaLinkUrl,(e=>{}),(e=>{console.error(e)}))},t.printMode=()=>{window.location.pathname===u.pathName&&t.printHtml()},t.printHtml=()=>{volantis.isReadModel&&t.readMode(),DOMController.setAttribute("details","open","true");DOMController.removeList([".cus-article-bkg",".iziToast-overlay",".iziToast-wrapper",".prev-next","footer","#l_header","#l_cover","#l_side","#comments","#s-top","#BKG","#rightmenu-wrapper",".nav-tabs",".new-meta-item.share",".new-meta-box","button.btn-copy","iframe"]);DOMController.setStyleList([["body","backgroundColor","unset"],["#l_main, .copyright.license","width","100%"],["#post","boxShadow","none"],["#post","background","none"],["#post","padding","0"],["h1","textAlign","center"],["h1","fontWeight","600"],["h1","fontSize","2rem"],["h1","marginBottom","20px"],[".tab-pane","display","block"],[".tab-content","borderTop","none"],[".highlight>table pre","whiteSpace","pre-wrap"],[".highlight>table pre","wordBreak","break-all"],[".fancybox img","height","auto"],[".fancybox img","weight","auto"],[".copyright.license","margin","0"],[".copyright.license","padding","1.25em 20px"],["figure.highlight, .copyright.license","display","inline-block"]]),setTimeout((()=>{window.print(),document.body.innerHTML="",window.location.reload()}),50)},t.readMode=()=>{"function"==typeof ScrollReveal&&ScrollReveal().clean("#comments");const e=[document.querySelector("#l_cover"),document.querySelector("footer"),document.querySelector("#s-top"),document.querySelector(".article-meta#bottom"),document.querySelector(".prev-next"),document.querySelector("#l_side"),document.querySelector("#comments")];DOMController.setStyle("#l_header","opacity",0),DOMController.fadeToggleList(e);if([["#l_main","common_read"],["#l_main","common_read_main"],["#l_body","common_read"],["#safearea","common_read"],["#pjax-container","common_read"],["#read_bkg","common_read_hide"],["h1","common_read_h1"],["#post","post_read"],["#l_cover","read_cover"],[".widget.toc-wrapper","post_read"]].forEach((([e,t])=>{DOMController.toggleClass(document.querySelector(e),t)})),DOMController.setStyle(".copyright.license","margin","15px 0"),volantis.isReadModel=void 0===volantis.isReadModel||!volantis.isReadModel,volantis.isReadModel){const e=e=>{DOMController.hasClass(e.target,"common_read")&&t.readMode()};document.querySelector("#l_body").removeEventListener("click",t.readMode),document.querySelector("#l_body").addEventListener("click",e)}else document.querySelector("#l_body").removeEventListener("click",t.readMode),document.querySelector("#post").removeEventListener("click",t.readMode),DOMController.setStyle(".prev-next","display","flex"),DOMController.setStyle(".copyright.license","margin","15px -40px"),DOMController.setStyle("#l_header","opacity","unset")},{init:t.initEvent,hideMenu:t.hideMenu,readMode:t.readMode}})(),Object.freeze(RightMenus),volantis.requestAnimationFrame((()=>{"loading"!==document.readyState?RightMenus.initialMenu():document.addEventListener("DOMContentLoaded",(function(){RightMenus.initialMenu()}))}));const DOMController={visible:(e,t=!0)=>{e&&(e.style.display=t?"block":"none")},remove:e=>{document.querySelectorAll(e).forEach((e=>e.remove()))},removeList:e=>{e.forEach(DOMController.remove)},setAttribute:(e,t,n)=>{document.querySelectorAll(e).forEach((e=>e.setAttribute(t,n)))},setAttributeList:e=>{e.forEach((([e,t,n])=>{DOMController.setAttribute(e,t,n)}))},setStyle:(e,t,n)=>{document.querySelectorAll(e).forEach((e=>e.style[t]=n))},setStyleList:e=>{e.forEach((([e,t,n])=>{DOMController.setStyle(e,t,n)}))},fadeIn:e=>{if(e)return Object.assign(e.style,{visibility:"visible",opacity:1,display:"block",transition:"all 0.5s linear"}),e},fadeOut:e=>{if(e)return Object.assign(e.style,{visibility:"hidden",opacity:0,display:"none",transition:"all 0.5s linear"}),e},fadeToggle:e=>{if(e)return"hidden"==e.style.visibility?DOMController.fadeIn(e):DOMController.fadeOut(e)},fadeToggleList:e=>{e.forEach(DOMController.fadeToggle)},hasClass:(e,t)=>!!e&&e.className.match(new RegExp(`(\\s|^)${t}(\\s|$)`)),addClass:(e,t)=>(e&&e.classList.add(t),e),removeClass:(e,t)=>(e&&e.classList.remove(t),e),toggleClass:(e,t)=>{if(e)return DOMController.hasClass(e,t)?DOMController.removeClass(e,t):DOMController.addClass(e,t)},toggleClassList:e=>{e.forEach((([e,t])=>{DOMController.toggleClass(e,t)}))}};Object.freeze(DOMController);