const contextMenuManager={urlRegx:/^(https?:\/\/)?([A-Za-z0-9.-]+)\.([A-Za-z]{2,})(\/[A-Za-z0-9.-]*)*\/?(\?[A-Za-z0-9&=_-]*)?(#[A-Za-z0-9-_]*)?$/,readModeStylesheet:document.getElementById("reading-mode-stylesheet"),maxMenuItems:0,isClipboardReadAllowed:!0};contextMenuManager.initializeContextMenu=function(e="#rightmenu-wrapper"){const t=document.querySelector(e);if(!t)return;this.maxMenuItems=Number(t.dataset.maxMenuItems);const n=Array.from(t.querySelectorAll(".navigation.menuNavigation-Content a")).map((e=>({id:e.dataset.id,displayCondition:e.dataset.displayCondition,menuContentElement:e}))),o=Array.from(t.querySelectorAll(".menuLoad-Content")).flatMap((e=>{const t=e.firstElementChild;return t?[{id:t.dataset.id,link:t.href,linkTarget:t.target,eventName:t.dataset.eventName,displayCondition:t.dataset.displayCondition,isHrElement:"HR"===t.tagName,menuContentElement:e}]:[]})),i={pointerEvent:null,linkAddress:null,selectedText:null,inputContent:null},r={inInputField:(e,t)=>{if("INPUT"===t.target.tagName||"TEXTAREA"===t.target.tagName)switch(i.inputContent=t.target,i.selectedText=window.getSelection().toString(),e.id){case"selectAllText":if(""!==i.inputContent.value)return!0;break;case"cutText":if(""!==i.selectedText)return!0;break;case"copyPaste":if(contextMenuManager.isClipboardReadAllowed)return!0;break;default:return!0}return!1},selectedText:()=>(i.selectedText=window.getSelection().toString(),""!==i.selectedText),onImage:(e,t)=>{const n=t.target;return!("IMG"!==n.tagName||!n.hasAttribute("src"))&&(i.linkAddress=n.src,!0)},onLink:(e,t)=>{if(this.urlRegx.test(i.selectedText))return i.linkAddress=i.selectedText,!0;const n=t.target;return"A"===n.tagName&&n.hasAttribute("href")?(i.linkAddress=n.href,!0):!("IMG"!==n.tagName||!n.hasAttribute("src"))&&(i.linkAddress=n.src,!0)},articlePage:e=>{if("prev"===e.id||"next"===e.id)return!!document.querySelector(`article .prev-next a.${e.id}`);if("comment"===e.id){const e=document.querySelector("#comments");return e&&!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length)&&window.scrollY<e.getBoundingClientRect().top-50+window.scrollY}return!!document.querySelector("#post.article")},scrolledFromTop:()=>(window.scrollY||document.documentElement.scrollTop)>=window.innerHeight/2,homePage:()=>"/"!==new URL(window.location.href).pathname},a={scrollTop:()=>{"function"==typeof volantis.scroll.to?volantis.scroll.to(volantis.dom.bodyAnchor):window.scrollTo({top:0,behavior:"smooth"})},scrollComment:()=>{const e=document.querySelector("#comments");"function"==typeof volantis.scroll.to?volantis.scroll.to(e):window.scrollTo({top:e.getBoundingClientRect().top+window.scrollY,behavior:"smooth"})},jumpArticle:e=>{const t=document.querySelector(`.prev-next a.${e.id}`);if(t){const e=t.href;"undefined"!=typeof pjax?pjax.loadUrl(e):window.location.href=e}},readMode:()=>{this.readModeStylesheet.disabled=!this.readModeStylesheet.disabled,this.readModeStylesheet.disabled?document.body.classList.remove("read-mode"):document.body.classList.add("read-mode")},printMode:()=>{this.readModeStylesheet.disabled||a.readMode(),document.querySelectorAll("details").forEach((e=>e.setAttribute("open","true"))),setTimeout((()=>{window.print()}),200)},copyText:()=>{VolantisApp.utilWriteClipText(i.selectedText)},copyLink:()=>{const e=i.pointerEvent.target;let t="";"IMG"===e.tagName&&(t=e.dataset.src||e.src),"A"===e.tagName&&(t=e.href),VolantisApp.utilWriteClipText(t)},copyImg:e=>{NProgress?.start();try{const e=i.pointerEvent.target.dataset.src||i.pointerEvent.target.src,t=new Image;t.crossOrigin="Anonymous",t.src=`${e}?(lll￢ω￢)~~`,t.onerror=null,t.onload=()=>{const e=document.createElement("canvas");e.width=t.width,e.height=t.height;e.getContext("2d").drawImage(t,0,0),e.toBlob((e=>{navigator.clipboard.write([new ClipboardItem({"image/png":e})]).finally((()=>{NProgress?.done()}))}),"image/png")}}catch(t){console.error(`Menu: ${e.id}, event:[${e.eventName}] error: ${t}`),NProgress?.done()}},selectAllText:()=>{i.inputContent.select()},cutText:e=>{let t="";"string"!=typeof e?VolantisApp.utilWriteClipText(i.selectedText):(VolantisApp.utilWriteClipText(e),t=e);const n=i.inputContent,{selectionStart:o,selectionEnd:r,scrollTop:a}=n;n.value=`${n.value.substring(0,o)}${t}${n.value.substring(r)}`,n.setSelectionRange(o+t.length,o+t.length),n.scrollTop=a,n.focus()},copyPaste:async(e,t)=>{try{NProgress?.start();const e=await navigator.permissions.query({name:"clipboard-read"});if("granted"!==e.state&&"prompt"!==e.state)throw contextMenuManager.isClipboardReadAllowed=!1,new Error("没有读取剪切板的权限！");{const e=await navigator.clipboard.read();let n="",o=[];for(const t of e){if(0===t.types.length)throw new Error("剪切板中没有可被读取的内容，目前仅支持文本和图像数据，暂不支持操作系统级别的文件复制粘贴操作。");for(const e of t.types)if(e.startsWith("image/")){const n=await t.getType(e),i=new File([n],"clipboard-image.png",{type:e});o.push(i)}else if("text/plain"===e){const o=await t.getType(e);n+=await o.text()}}a.cutText(n);for(const e of o){const n=new DataTransfer;n.items.add(e);const o=new ClipboardEvent("paste",{clipboardData:n,bubbles:!0,cancelable:!0});t.target.dispatchEvent(o)}contextMenuManager.isClipboardReadAllowed=!0}NProgress?.done()}catch(e){console.error(`粘贴失败，详细信息: ${e}`),a.cutText(e.toString()),contextMenuManager.isClipboardReadAllowed=!1,NProgress?.done()}}},s=(e,t,n=[])=>{const o=t[e],r=o.match(/^([^\(]+)\((.*)\)$/);let a,s;if(r?(a=r[1].trim(),s=r[2].split(",").map((e=>e.trim().replace(/['"]/g,"")))):(a=o.trim(),s=[]),1===s.length){const e=s[0];if(i[e])s[0]=i[e];else{const t=e.match(/##(.*?)##/);if(t){const n=i[t[1]];n&&"string"==typeof n&&(s[0]=e.replace(t[0],n))}}}try{const o=a.split(".");let i=window,r=null;for(let n=0;n<o.length;n++)if(r=i,i=i[o[n]],void 0===i)return void console.error(`Invalid ${e}: ${t[e]}`);if("function"==typeof i)return i.apply(r,s.concat(n));{const{menuContentElement:n,...o}=t;console.error(`Invalid ${e} [${t[e]}], Menu: ${JSON.stringify(o)}`)}}catch(e){console.error(e)}},l=(e,t)=>{if(!e.displayCondition)return!0;if(r[e.displayCondition])return r[e.displayCondition](e,t);const n=s("displayCondition",e,[t]);return"boolean"==typeof n&&n},c=e=>{let t=0;o.forEach((n=>{l(n,e)?(n.menuContentElement.classList.add("active"),n.isHrElement||t++):n.menuContentElement.classList.remove("active")})),t>this.maxMenuItems&&o.forEach((e=>{e.link&&e.menuContentElement.classList.remove("active")}));let i=null;if(o.forEach((e=>{e.isHrElement?(e.menuContentElement.classList.add("active"),i&&i.classList.remove("active"),i=e.menuContentElement):e.menuContentElement.classList.contains("active")&&(i=null)})),i&&i.classList.remove("active"),0===n.length){const e=o.find((e=>e.menuContentElement.classList.contains("active")));e.isHrElement&&e.menuContentElement.classList.remove("active")}n.forEach((t=>{t.menuContentElement.style.display=l(t,e)?"flex":"none"}))},d=()=>{t.classList.contains("active")&&t.classList.remove("active")};document.addEventListener("contextmenu",(e=>{if(d(),i.pointerEvent=e,e.ctrlKey||document.body.offsetWidth<=500)return!0;try{(e=>{e.preventDefault(),c(e),t.classList.add("active");const{clientX:n,clientY:o}=e,i=document.documentElement.clientWidth||document.body.clientWidth,r=document.documentElement.clientHeight||document.body.clientHeight,a=t.offsetWidth,s=t.offsetHeight;let l=n+a>i?n-a+10:n,d=o+s>r?o-s+10:o;o+s>r&&d<s&&o<s&&(d+=r-s-d-10),t.style.left=`${l}px`,t.style.top=`${d}px`})(e),window.removeEventListener("blur",d),document.body.removeEventListener("click",d),window.addEventListener("blur",d),document.body.addEventListener("click",d),volantis.scroll.push(d)}catch(e){return console.error("Error positioning menu:",e),!0}})),t.addEventListener("contextmenu",(e=>(e.stopPropagation(),e.preventDefault(),!1))),t.addEventListener("click",(e=>{const t=e.target.closest(".menuNavigation-Content a"),r=e.target.closest(".menuLoad-Content span"),l=t||r;l&&l.dataset.eventName&&l.dataset.id&&((e,t,r)=>{const l=o.find((n=>n.eventName===t&&n.id===e))||n.find((n=>n.eventName===t&&n.id===e))||{id:e,eventName:t};a[t]?a[t](l,i.pointerEvent):s("eventName",l,[r,i.pointerEvent])})(l.dataset.id,l.dataset.eventName,e)}));try{volantis.pjax.send((()=>{d(),this.readModeStylesheet.disabled||a.readMode()}))}catch(e){console.error(`Pjax error: ${e}`)}},"loading"!==document.readyState?contextMenuManager.initializeContextMenu():document.addEventListener("DOMContentLoaded",(()=>{contextMenuManager.initializeContextMenu()}));