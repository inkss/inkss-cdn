const RightMenus={defaultEvent:["copyText","copyLink","copyPaste","copyAll","copyCut","copyImg","printMode","readMode","jumpArticle"],defaultGroup:["navigation","inputBox","selectText","elementCheck","elementImage","articlePage"],corsAnywhere:volantis.GLOBAL_CONFIG.plugins.rightmenus.options.corsAnywhere,urlRegx:/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/,imgRegx:/\.(jpe?g|png|webp|svg|gif|jifi|avif)(-|_|!|\?|\/)?.*$/,initialMenu:()=>{RightMenus.fun.init(),volantis.pjax.send((()=>{RightMenus.fun.hideMenu(),volantis.isReadModel&&RightMenus.fun.readMode()})),volantis.pjax.push((()=>{RightMenus.fun.updateDate()}))},readClipboard:async()=>{try{const e=await navigator.permissions.query({name:"clipboard-read"});if("granted"===e.state||"prompt"===e.state)return navigator.clipboard.read();window.clipboardRead=!1}catch(e){console.error("读取剪切板失败: ",e),window.clipboardRead=!1}return null},writeClipText:e=>navigator.clipboard.writeText(e).then((()=>Promise.resolve())).catch((e=>Promise.reject(e))),writeClipImg:async(e,t,n)=>{try{const i=new Image;i.crossOrigin="Anonymous",i.src=`${e}?(lll￢ω￢)~~`,i.onload=()=>{const e=document.createElement("canvas");e.width=i.width,e.height=i.height;e.getContext("2d").drawImage(i,0,0),e.toBlob((e=>{navigator.clipboard.write([new ClipboardItem({"image/png":e})]).then(t).catch(n)}),"image/png")},i.onerror=n}catch(e){n(e)}},insertAtCaret:(e,t)=>{const{selectionStart:n,selectionEnd:i,scrollTop:o}=e,a=e.value.substring(0,n)+t+e.value.substring(i);e.value=a,e.setSelectionRange(n+t.length,n+t.length),e.scrollTop=o,e.focus()}};RightMenus.fun=(()=>{const e=volantis.GLOBAL_CONFIG.plugins.rightmenus,t={},n=document.getElementById("rightmenu-wrapper"),i=document.getElementById("rightmenu-content"),o=document.querySelectorAll("#rightmenu-content li.menuLoad-Content"),a=document.querySelectorAll("#rightmenu-content li, #rightmenu-content hr, #menuMusic"),r=(document.getElementById("read_bkg"),document.getElementById("menuMusic")),s=document.querySelector("#menuMusic .backward"),l=document.querySelector("#menuMusic .toggle"),c=document.querySelector("#menuMusic .forward");let d={mouseEvent:null,isInputBox:!1,selectText:"",inputValue:"",isLink:!1,linkUrl:"",isMediaLink:!1,mediaLinkUrl:"",isImage:!1,isArticle:!1,pathName:"",isReadClipboard:!0,isShowMusic:!1,statusCheck:!1};const u={...d};return t.initEvent=()=>{t.contextmenu(),t.menuEvent(),t.updateDate()},t.menuPosition=e=>{try{const{clientX:o,clientY:a}=e,r=document.documentElement.clientWidth||document.body.clientWidth,s=document.documentElement.clientHeight||document.body.clientHeight;n.style.display="block",t.menuControl(e);const l=i.offsetWidth,c=i.offsetHeight;let d=o+l>r?o-l+10:o,u=a+c>s?a-c+10:a;a+c>s&&u<c&&a<c&&(u+=s-c-u-10),n.style.left=`${d}px`,n.style.top=`${u}px`}catch(e){return console.error(e),t.hideMenu(),!0}return!1},t.menuControl=n=>{t.globalDataSet(n),r&&(r.style.display=d.isShowMusic?"block":"none"),o.forEach((t=>{const{nodeName:n,dataset:{group:i,event:o}}=t.firstElementChild;t.style.display="none";const a=()=>{t.style.display="block"};if(d.statusCheck||d.isArticle)switch(i){case"inputBox":if(d.isInputBox){["copyCut"!==o||d.selectText,"copyAll"!==o||d.inputValue,"copyPaste"!==o||d.isReadClipboard].every((e=>e))&&a()}break;case"selectText":d.selectText&&a();break;case"elementCheck":(d.isLink||d.isMediaLink)&&a();break;case"elementImage":d.isImage&&a();break;case"articlePage":d.isArticle&&a();break;case"prevNext":const i="prev"===t.firstElementChild.id,r="next"===t.firstElementChild.id,s=document.querySelector(".prev-next > a.prev"),l=document.querySelector(".prev-next > a.next");(i&&s||r&&l)&&a();break;default:("A"!==n||d.isArticle&&!d.statusCheck&&e.options.articleShowLink)&&a()}else"A"!==n&&RightMenus.defaultGroup.includes(i)||a()})),volantis.mouseEvent=n,volantis.rightmenu.method.handle.start();let i=null;a.forEach((e=>{"HR"===e.nodeName?(e.style.display="block",i&&(i.style.display="none"),i=e):"block"===e.style.display&&(i=null)})),i&&(i.style.display="none")},t.globalDataSet=t=>{d={...u},d.mouseEvent=t,d.selectText=window.getSelection().toString();const n=t.target.tagName.toLowerCase();d.isInputBox="input"===n||"textarea"===n,d.isInputBox&&(d.inputValue=t.target.value,d.isReadClipboard=!1!==window.clipboardRead);const{href:i,currentSrc:o}=t.target,{urlRegx:a,imgRegx:r}=RightMenus;d.isLink=!!i&&a.test(i),d.linkUrl=d.isLink?i:void 0,d.isMediaLink=!!o&&a.test(o),d.mediaLinkUrl=d.isMediaLink?o:void 0,d.isImage=d.isMediaLink&&r.test(d.mediaLinkUrl),d.isArticle=!!document.querySelector("#post.article"),d.pathName=d.isArticle?window.location.pathname:void 0;const s=volantis.GLOBAL_CONFIG.plugins.aplayer?.enable,l="undefined"!=typeof RightMenuAplayer&&RightMenuAplayer.APlayer.player;if(s&&l){const t=RightMenuAplayer.APlayer.status;d.isShowMusic=e.options.musicAlwaysShow||"play"===t||"undefined"===t}d.statusCheck=!!d.selectText||d.isInputBox||d.isLink||d.isMediaLink},t.contextmenu=()=>{document.oncontextmenu=e=>e.ctrlKey||document.body.offsetWidth<=500?(t.hideMenu(),!0):t.menuPosition(e),n.oncontextmenu=e=>(e.stopPropagation(),e.preventDefault(),!1);const e=()=>t.hideMenu();window.removeEventListener("blur",e),window.addEventListener("blur",e),document.body.removeEventListener("click",e),document.body.addEventListener("click",e)},t.menuEvent=()=>{o.forEach((e=>{if("A"===e.firstElementChild.nodeName)return;const n=e.firstElementChild.getAttribute("id"),i=e.firstElementChild.getAttribute("data-event"),o=e.firstElementChild.getAttribute("data-group");e.addEventListener("click",(e=>{try{if(RightMenus.defaultEvent.includes(i))t[i](e);else switch(o){case"selectText":RightMenusFunction[n](d.selectText);break;case"elementCheck":RightMenusFunction[n](d.isLink?d.linkUrl:d.mediaLinkUrl);break;case"elementImage":RightMenusFunction[n](d.mediaLinkUrl);break;default:RightMenusFunction[n](e)}}catch(e){"rightMenus"===volantis.GLOBAL_CONFIG.debug&&console.error({id:n,error:e,globalData:d,groupName:o,eventName:i})}}))})),c&&l&&s&&(s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerBackward()})),l.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerToggle()})),c.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),RightMenuAplayer.aplayerForward()})))},t.hideMenu=()=>{n.style.display=null,n.style.left=null,n.style.top=null},t.copyText=()=>{VolantisApp.utilWriteClipText(d.selectText)},t.copyLink=()=>{VolantisApp.utilWriteClipText(d.linkUrl||d.mediaLinkUrl)},t.copyAll=()=>{d.mouseEvent.target.select()},t.copyPaste=async()=>{try{NProgress?.start();const e=await RightMenus.readClipboard();if(null===e&&!1===window?.clipboardRead)throw new Error("没有读取剪切板的权限！");let t="",n=[];for(const i of e){if(0===i.types.length)throw new Error("剪切板中没有可被读取的内容，目前仅支持文本和图像数据，暂不支持操作系统级别的文件复制粘贴操作。");for(const e of i.types)if(e.startsWith("image/")){const t=await i.getType(e),o=new File([t],"clipboard-image.png",{type:e});n.push(o)}else if("text/plain"===e){const n=await i.getType(e);t+=await n.text()}}RightMenus.insertAtCaret(d.mouseEvent.target,t);for(const e of n){const t=new DataTransfer;t.items.add(e);const n=new ClipboardEvent("paste",{clipboardData:t,bubbles:!0,cancelable:!0});d.mouseEvent.target.dispatchEvent(n)}NProgress?.done()}catch(e){console.error(`粘贴失败，详细信息: ${e.stack}`),RightMenus.insertAtCaret(d.mouseEvent.target,e),NProgress?.done()}},t.copyCut=()=>{const{selectionStart:e,selectionEnd:n,value:i}=d.mouseEvent.target;t.copyText(d.selectText),d.mouseEvent.target.value=i.substring(0,e)+i.substring(n),d.mouseEvent.target.setSelectionRange(e,e),d.mouseEvent.target.focus()},t.copyImg=()=>{NProgress?.start(),RightMenus.writeClipImg(d.mediaLinkUrl,(e=>{NProgress?.done()}),(e=>{NProgress?.done(),console.error(e)}))},t.printMode=()=>{window.location.pathname===d.pathName&&t.printHtml()},t.printHtml=()=>{volantis.isReadModel&&t.readMode(),document.querySelectorAll("details").forEach((e=>e.setAttribute("open","true"))),setTimeout((()=>{window.print()}),200)},t.readMode=()=>{if(!d.isArticle)return;const e=document.getElementById("reading-mode-stylesheet");e.disabled=!e.disabled,volantis.isReadModel=!e.disabled,volantis.isReadModel?document.body.classList.add("read-mode"):document.body.classList.remove("read-mode")},t.jumpArticle=e=>{const t=`article .prev-next a.${"prev"===e.target.id?"prev":"next"}`,n=document.querySelector(t);if(n){const e=n.href;"undefined"!=typeof pjax?pjax.loadUrl(e):window.location.href=e}},t.updateDate=()=>{d.isArticle=!!document.querySelector("#post.article")},{init:t.initEvent,hideMenu:t.hideMenu,readMode:t.readMode,updateDate:t.updateDate}})(),Object.freeze(RightMenus),volantis.requestAnimationFrame((()=>{"loading"!==document.readyState?RightMenus.initialMenu():document.addEventListener("DOMContentLoaded",(function(){RightMenus.initialMenu()}))}));